{% extends "layout.html" %}
{% block title %}Return Product{% endblock title %}
{% block content %}

<div class="max-w-5xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
  
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
      <i class="ri-arrow-go-back-line text-purple-600"></i> Return Products
    </h2>
    <a href="\" 
       class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">
      <i class="ri-file-list-3-line"></i> View Returns
    </a>
  </div>

  <!-- Form -->
  <form id="returnForm" method="post" class="overflow-x-auto">
    <table class="table-auto w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-purple-600 text-white text-left">
          <th class="px-4 py-3"><i class="ri-price-tag-3-line mr-1"></i> Product</th>
          <th class="px-4 py-3"><i class="ri-ruler-line mr-1"></i> Unit</th>
          <th class="px-4 py-3"><i class="ri-barcode-line mr-1"></i> Details</th>
          <th class="px-4 py-3"><i class="ri-stack-line mr-1"></i> Quantity</th>
          <th class="px-4 py-3 text-center"><i class="ri-tools-line"></i> Action</th>
        </tr>
      </thead>
      <tbody id="returnTableBody">
        <tr class="border-b hover:bg-gray-50">
          <!-- Product dropdown -->
          <td class="px-4 py-2">
            <select name="product_id[]" class="input productSelect" required>
              <option value="">-- Select Product --</option>
              {% for p in product %}
              <option value="{{ p.id }}" data-unit="{{ p.unit }}">{{ p.Name }}</option>
              {% endfor %}
            </select>
          </td>

          <!-- Auto-filled Unit -->
          <td class="px-4 py-2">
            <input type="text" name="unit[]" class="input unitInput" readonly>
          </td>

          <!-- Conditional Details -->
          <td class="px-4 py-2 detailsCell">
            <input type="text" class="input placeholder-gray-400" placeholder="Select a product first" disabled>
          </td>

          <!-- Quantity -->
          <td class="px-4 py-2">
            <input type="number" name="quantity[]" class="input" required>
          </td>

          <!-- Remove -->
          <td class="px-4 py-2 text-center">
            <button type="button" class="btn-danger removeRow">
              <i class="ri-delete-bin-6-line"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Actions -->
    <div class="flex justify-between items-center mt-6">
      <button type="button" id="addRow" class="btn-success">
        <i class="ri-add-line"></i> Add Row
      </button>
      <button type="submit" class="btn-primary">
        <i class="ri-send-plane-line"></i> Submit Return
      </button>
    </div>
  </form>
</div>

<!-- Barcode Scanner -->
<div id="scannerBox" class="hidden mt-6 p-4 border rounded-xl bg-gray-50 max-w-md mx-auto shadow">
  <h3 class="text-lg font-semibold flex items-center gap-2 mb-3 text-gray-700">
    <i class="ri-qr-scan-line text-purple-600"></i> Scan Barcode
  </h3>
  <div id="scanner-container" class="mx-auto w-[280px] h-[200px] overflow-hidden border rounded-lg"></div>
  <p class="mt-3 text-sm">Detected: <span id="detectedCode" class="font-mono text-purple-600">-</span></p>
  <div class="mt-4 flex gap-3 justify-center">
    <button class="btn-primary px-3 py-1 text-sm" onclick="confirmCode()">
      <i class="ri-checkbox-circle-line"></i> Confirm
    </button>
    <button class="btn-danger px-3 py-1 text-sm" onclick="closeScanner()">
      <i class="ri-close-line"></i> Cancel
    </button>
  </div>
</div>

<!-- Styles -->
<style>
  .input {
    @apply w-full bg-gray-100 rounded-lg px-3 py-2 border border-gray-200 focus:ring-2 focus:ring-purple-400 focus:outline-none;
  }
  .btn-primary {
    @apply bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition flex items-center gap-2;
  }
  .btn-success {
    @apply bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition flex items-center gap-2;
  }
  .btn-danger {
    @apply bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center;
  }
</style>

<!-- QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
  const tableBody = document.getElementById('returnTableBody');
  let activeBarcodeInput = null;
  let lastDetected = null;

  // Product change: fill unit and details
  tableBody.addEventListener("change", function(e) {
    if (e.target && e.target.classList.contains("productSelect")) {
      const unit = e.target.selectedOptions[0].dataset.unit;
      const row = e.target.closest("tr");
      row.querySelector(".unitInput").value = unit;

      const detailsCell = row.querySelector(".detailsCell");
      detailsCell.innerHTML = "";

      if (unit === "meter") {
        detailsCell.innerHTML = `
          <div class="flex gap-2">
            <input type="number" name="meter_from[]" class="input" placeholder="From" required>
            <input type="number" name="meter_to[]" class="input" placeholder="To" required>
          </div>`;
      } else {
        detailsCell.innerHTML = `
          <div class="flex gap-2">
            <input type="text" name="barcode[]" class="input barcodeInput" placeholder="Enter or Scan">
            <button type="button" class="btn-success scanBtn"><i class="ri-qr-scan-line"></i></button>
          </div>`;
      }
    }
  });

  // Add row
  document.getElementById('addRow').addEventListener('click', () => {
    const newRow = tableBody.rows[0].cloneNode(true);
    newRow.querySelectorAll("input").forEach(input => { input.value = ""; input.disabled = false; });
    newRow.querySelector(".detailsCell").innerHTML = `<input type="text" class="input" placeholder="Select a product first" disabled>`;
    tableBody.appendChild(newRow);
  });

  // Remove row
  tableBody.addEventListener('click', e => {
    if (e.target.closest('.removeRow') && tableBody.rows.length > 1) {
      e.target.closest('tr').remove();
    }
  });

  // Barcode scan
  tableBody.addEventListener("click", e => {
    if (e.target.closest(".scanBtn")) {
      activeBarcodeInput = e.target.closest("td").querySelector(".barcodeInput");
      openScanner();
    }
  });

  function openScanner() {
    document.getElementById("scannerBox").classList.remove("hidden");
    lastDetected = null;
    document.getElementById("detectedCode").textContent = "-";

    Quagga.init({
      inputStream: { type: "LiveStream", target: document.querySelector('#scanner-container'), constraints: { facingMode: "environment" } },
      decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"] }
    }, err => { if (!err) Quagga.start(); });

    Quagga.onDetected(data => {
      if (!lastDetected) {
        lastDetected = data.codeResult.code;
        document.getElementById("detectedCode").textContent = lastDetected;
      }
    });
  }

  function confirmCode() {
    if (lastDetected && activeBarcodeInput) activeBarcodeInput.value = lastDetected;
    closeScanner();
  }

  function closeScanner() {
    Quagga.stop();
    document.getElementById("scannerBox").classList.add("hidden");
  }
</script>

{% endblock content %}
